<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HappyToilet</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0B1B33;color:#EAF2FF}
header{padding:15px;background:#11284A}
main{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 60px)}
#map{height:100%}
.list{overflow:auto;height:100%;padding:10px}
.item{background:#11284A;margin-bottom:10px;padding:10px;border-radius:10px;cursor:pointer}
.item:hover{background:#1c3a63}
.detail{padding:15px}
button{background:#2E6BB5;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
</style>
</head>

<body>

<header>
<h2>ğŸš» HappyToilet Â· ì„œìš¸ì‹œ ì „ì²´</h2>
</header>

<main>

<div>
<div id="map"></div>
</div>

<div class="list" id="toiletList">
ì´ˆê¸° ë¡œë”© ì¤‘...
</div>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {

let map = L.map("map").setView([37.5665,126.9780], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19
}).addTo(map);

let cluster = L.markerClusterGroup();
map.addLayer(cluster);

let allToilets = [];
let myLocation = null;

function renderList(list){
const el = document.getElementById("toiletList");
if(!list.length){
el.innerHTML="ë°ì´í„° ì—†ìŒ";
return;
}
el.innerHTML = list.slice(0,500).map(t => `
<div class="item" onclick="selectToilet('${t.toiletId}')">
<b>${t.name || "ì´ë¦„ì—†ìŒ"}</b><br/>
${t.addr || ""}
</div>
`).join("");
}

function renderMarkers(list){
cluster.clearLayers();
list.forEach(t=>{
const lat = Number(t.lat);
const lng = Number(t.lng);
if(!lat || !lng) return;
const marker = L.marker([lat,lng]);
marker.bindPopup(`<b>${t.name}</b><br>${t.addr}`);
marker.on("click",()=>selectToilet(t.toiletId));
cluster.addLayer(marker);
});
}

window.selectToilet = function(id){
const t = allToilets.find(x=>x.toiletId==id);
if(!t) return;

const lat = Number(t.lat);
const lng = Number(t.lng);
map.setView([lat,lng],17);

const nav = `
<br/><br/>
<button onclick="navigateTo(${lat},${lng})">ğŸ“ ê¸¸ì•ˆë‚´</button>
`;

document.getElementById("toiletList").innerHTML = `
<div class="detail">
<h3>${t.name}</h3>
<p>${t.addr}</p>
${nav}
<button onclick="loadAll()">â† ëª©ë¡ìœ¼ë¡œ</button>
</div>
`;
}

window.navigateTo = function(lat,lng){
if(myLocation){
window.open(`https://map.kakao.com/link/from/ë‚´ìœ„ì¹˜,${myLocation.lat},${myLocation.lng}/to/í™”ì¥ì‹¤,${lat},${lng}`);
}else{
window.open(`https://map.kakao.com/link/to/í™”ì¥ì‹¤,${lat},${lng}`);
}
}

function getMyLocation(){
if(!navigator.geolocation) return;
navigator.geolocation.getCurrentPosition(pos=>{
myLocation = {
lat: pos.coords.latitude,
lng: pos.coords.longitude
};
L.circleMarker([myLocation.lat,myLocation.lng],{
radius:8,color:"red"
}).addTo(map).bindPopup("ë‚´ ìœ„ì¹˜");
});
}

async function loadAll(){
document.getElementById("toiletList").innerHTML="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
try{
const res = await fetch("/api/toilets/all");
const data = await res.json();
allToilets = data.rows || [];

renderList(allToilets);
renderMarkers(allToilets);

}catch(e){
document.getElementById("toiletList").innerHTML="ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
}
}

getMyLocation();
loadAll();

});
</script>

</body>
</html>
