<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HappyToilet | ì„œìš¸ì‹œ ê³µì¤‘í™”ì¥ì‹¤ ì§€ë„Â·ë¦¬ë·°</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0B1B33;
      --panel:#11284A;
      --panel2:#0E2342;
      --line:rgba(234,242,255,.12);
      --text:#EAF2FF;
      --muted:rgba(234,242,255,.72);
      --accent:#2E6BB5;
      --good:#39C6A2;
      --mid:#F7C948;
      --bad:#FF6B6B;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo",
              "Noto Sans KR", "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 0%, rgba(46,107,181,.18), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(57,198,162,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1150px;margin:0 auto;padding:22px}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:14px 16px;
      background:linear-gradient(180deg, rgba(17,40,74,.92), rgba(17,40,74,.72));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(46,107,181,1), rgba(57,198,162,1));
      display:grid;place-items:center;
      box-shadow: 0 8px 20px rgba(46,107,181,.22);
      font-weight:900;
      letter-spacing:.5px;
    }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;
      background:rgba(14,35,66,.65);
      white-space:nowrap;
    }

    main{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(17,40,74,.92), rgba(14,35,66,.86));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 220px;
    }
    .card .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .card .hd h2{margin:0; font-size:15px}
    .card .bd{padding:16px}

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .input{
      flex:1 1 220px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(11,27,51,.25);
      color:var(--text);
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    button{
      all:unset;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(11,27,51,.25);
      color:var(--text);
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    button.primary{
      background:linear-gradient(135deg, rgba(46,107,181,.95), rgba(46,107,181,.55));
      border-color:rgba(46,107,181,.55);
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px)}
    .badge{
      font-size:11px; padding:6px 8px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(14,35,66,.6);
      color:var(--muted);
      white-space:nowrap;
    }
    .small{font-size:11px;color:rgba(234,242,255,.55);margin-top:8px;line-height:1.4}
    .ok{color:rgba(57,198,162,.95)}
    .warn{color:rgba(247,201,72,.95)}
    .err{color:rgba(255,107,107,.95)}

    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height:420px; overflow:auto; padding-right:6px;
    }
    .item{
      border:1px solid var(--line);
      background:rgba(11,27,51,.28);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
    }
    .item:hover{border-color:rgba(46,107,181,.45)}
    .item.active{
      border-color:rgba(46,107,181,.75);
      box-shadow: 0 0 0 3px rgba(46,107,181,.16);
    }
    .itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .title{margin:10px 0 0; font-weight:900; font-size:14px; line-height:1.35}
    .addr{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.4}
    .metaLine{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(11,27,51,.35);
      color:var(--muted);
    }

    .toiletTitle{font-size:18px;margin:0}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tag{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(11,27,51,.35);
      font-size:12px;color:var(--muted);
    }

    .scoreGrid{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:10px; margin-top:14px;
    }
    @media (max-width:450px){ .scoreGrid{grid-template-columns:1fr 1fr} }
    .metric{
      border:1px solid var(--line);
      background:rgba(11,27,51,.28);
      border-radius:14px;
      padding:12px;
    }
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-size:18px;font-weight:900;margin-top:6px}
    .metric .hint{font-size:11px;color:var(--muted);margin-top:6px}

    .reviewItem{
      border:1px solid var(--line);
      background:rgba(11,27,51,.28);
      border-radius:16px;
      padding:12px;
    }
    .stars{font-weight:900}
    .desc{margin:10px 0 0; color:var(--text); line-height:1.5; font-size:13px}
    .sub{margin:10px 0 0; color:var(--muted); font-size:12px}

    .formGrid{display:grid; gap:10px; margin-top:14px}
    .field{display:grid; gap:6px}
    label{font-size:12px; color:var(--muted)}
    select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(11,27,51,.25);
      color:var(--text);
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}

    #map{
      width:100%;
      height:300px;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      margin-bottom:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">HT</div>
        <div>
          <h1>HappyToilet</h1>
          <p>ì„œìš¸ì‹œ ê³µì¤‘í™”ì¥ì‹¤ Â· ë‚´ ì£¼ë³€ 2km Â· í´ëŸ¬ìŠ¤í„° ì§€ë„</p>
        </div>
      </div>
      <div class="pill" id="pill">toiletId: -</div>
    </header>

    <main>
      <!-- LEFT: ì§€ë„ + ëª©ë¡ -->
      <section class="card">
        <div class="hd">
          <h2>ì§€ë„ & ëª©ë¡</h2>
          <div class="controls">
            <input id="q" class="input" placeholder="ê²€ìƒ‰ (ì´ë¦„/ì£¼ì†Œ/êµ¬)" />
            <button class="primary" id="btnMyLocation">ğŸ“ ë‚´ ìœ„ì¹˜</button>
            <button id="btnToggle2km">2km ON</button>
            <button id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <div class="bd">
          <div class="small" id="status">ì´ˆê¸° ë¡œë”© ì¤‘â€¦</div>

          <div id="map"></div>

          <div class="small" id="rangeInfo"></div>
          <div class="list" id="toiletList"></div>
        </div>
      </section>

      <!-- RIGHT: ìƒì„¸ + ë¦¬ë·° -->
      <section class="card">
        <div class="hd">
          <h2>ìƒì„¸ & ë¦¬ë·°</h2>
          <div class="controls">
            <button id="btnShare">ë§í¬ ê³µìœ </button>
            <button id="btnCopyQR" class="primary">QRìš© ë§í¬ ë³µì‚¬</button>
          </div>
        </div>

        <div class="bd">
          <h3 class="toiletTitle" id="toiletTitle">í™”ì¥ì‹¤ì„ ì„ íƒí•´ì¤˜</h3>
          <div class="meta" id="toiletMeta">ì§€ë„ í•€ ë˜ëŠ” ì™¼ìª½ ëª©ë¡ì—ì„œ ì„ íƒí•´ì¤˜ ğŸ™‚</div>

          <div class="row" id="tags"></div>
          <div class="scoreGrid" id="scoreGrid"></div>

          <div style="margin-top:14px">
            <div class="badge">ë¦¬ë·° ëª©ë¡</div>
            <div style="margin-top:10px" class="list" id="reviewList"></div>
          </div>

          <div style="margin-top:14px">
            <div class="badge">ë¦¬ë·° ì‘ì„±</div>
            <div class="formGrid">
              <div class="field">
                <label for="category">í•­ëª©</label>
                <select id="category">
                  <option value="ì²­ê²°">ì²­ê²°</option>
                  <option value="ë¹„ë°">ë¹„ë°</option>
                  <option value="íœ´ì§€">íœ´ì§€</option>
                  <option value="ëƒ„ìƒˆ">ëƒ„ìƒˆ</option>
                  <option value="ì„¸ë©´ëŒ€">ì„¸ë©´ëŒ€</option>
                  <option value="ì•ˆì „">ì•ˆì „</option>
                </select>
              </div>
              <div class="field">
                <label for="rating">í‰ì (1~5)</label>
                <select id="rating">
                  <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
                </select>
              </div>
              <div class="field">
                <label for="comment">í•œ ì¤„ í›„ê¸°</label>
                <textarea id="comment" placeholder="ì˜ˆ: íœ´ì§€ê°€ ë„‰ë„‰í•˜ê³  ëƒ„ìƒˆê°€ ê±°ì˜ ì—†ì—ˆì–´ìš”."></textarea>
              </div>
              <button class="primary" id="btnAdd">ë¦¬ë·° ë“±ë¡</button>
              <div class="small" id="debug"></div>
            </div>
          </div>

          <div class="small" style="margin-top:12px">
            íŒ Â· QR/NFCë¡œ ë“¤ì–´ì˜¤ë ¤ë©´ <b>?t=OBJECTID</b> í˜•íƒœì˜ URLì„ íƒœê·¸ì— ë„£ì–´ì¤˜!
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id) => document.getElementById(id);

      // ---------- utils ----------
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function prettyPipe(s) {
        return String(s || "").replaceAll("|", "").replace(/\s+/g, " ").trim();
      }
      function setStatus(msg, cls="") {
        const el = $("status");
        if (!el) return;
        el.className = "small " + cls;
        el.innerHTML = msg;
      }
      function setDebug(msg, cls="") {
        const el = $("debug");
        if (!el) return;
        el.className = "small " + cls;
        el.innerHTML = msg;
      }

      function getToiletIdFromURL() {
        const url = new URL(window.location.href);
        return url.searchParams.get("t") || url.searchParams.get("toiletId") || "";
      }
      function setToiletIdToURL(toiletId) {
        const url = new URL(window.location.href);
        url.searchParams.set("t", toiletId);
        history.replaceState({}, "", url.toString());
        $("pill").textContent = `toiletId: ${toiletId || "-"}`;
      }

      // ---------- reviews(localStorage) ----------
      const storageKey = (toiletId) => `happytoilet:reviews:${toiletId}`;
      function loadReviews(toiletId) {
        if (!toiletId) return [];
        try {
          const raw = localStorage.getItem(storageKey(toiletId));
          return raw ? JSON.parse(raw) : [];
        } catch { return []; }
      }
      function saveReviews(toiletId, reviews) {
        localStorage.setItem(storageKey(toiletId), JSON.stringify(reviews));
      }
      function addReview(toiletId, { category, rating, text }) {
        const reviews = loadReviews(toiletId);
        reviews.unshift({
          category,
          rating: Number(rating),
          text,
          by: "ìµëª…",
          time: new Date().toLocaleString("ko-KR", { dateStyle:"short", timeStyle:"short" })
        });
        saveReviews(toiletId, reviews);
        return reviews;
      }
      function starText(r) {
        const n = Math.max(1, Math.min(5, Number(r)));
        return "â˜…".repeat(n) + "â˜†".repeat(5-n);
      }
      function moodColor(v){
        if (v >= 4.5) return "var(--good)";
        if (v >= 3.7) return "var(--mid)";
        return "var(--bad)";
      }
      function computeMetricsFromReviews(reviews) {
        const categories = ["ì²­ê²°","ë¹„ë°","íœ´ì§€"];
        const out = {};
        for (const c of categories) {
          const arr = reviews.filter(r => r.category === c).map(r => r.rating);
          out[c] = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null;
        }
        return out;
      }

      // ---------- distance ----------
      function haversineMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (d) => d * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat/2)**2 +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return 2 * R * Math.asin(Math.sqrt(a));
      }

      // ---------- map + clustering ----------
      let map = null;
      let cluster = null;
      let myMarker = null;

      function initMap() {
        map = L.map("map").setView([37.5665, 126.9780], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap"
        }).addTo(map);

        cluster = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true
        });
        map.addLayer(cluster);
      }

      function renderClusterMarkers(list) {
        if (!map || !cluster) return;
        cluster.clearLayers();

        for (const t of list) {
          const lat = Number(t.lat);
          const lng = Number(t.lng);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

          const marker = L.marker([lat, lng]);
          marker.bindPopup(
            `<b>${escapeHtml(t.name)}</b><br/>${escapeHtml(t.addr)}`
          );
          marker.on("click", () => selectToiletById(t.toiletId));
          cluster.addLayer(marker);
        }
      }

      function fitTo(list) {
        const pts = [];
        for (const t of list) {
          const lat = Number(t.lat), lng = Number(t.lng);
          if (Number.isFinite(lat) && Number.isFinite(lng)) pts.push([lat, lng]);
        }
        if (!pts.length) return;
        map.fitBounds(pts, { padding: [30, 30] });
      }

      // ---------- app state ----------
      let allToilets = [];      // ì„œìš¸ ì „ì²´
      let viewToilets = [];     // í˜„ì¬ í‘œì‹œ(2km/ê²€ìƒ‰ ë°˜ì˜)
      let selectedId = "";
      let selectedToilet = null;

      let myPos = null;         // {lat,lng}
      let filter2kmOn = true;   // ê¸°ë³¸ ON (ìš”ì²­ëŒ€ë¡œ)

      

      function applyFiltersAndRender() {
        const q = ($("q").value || "").trim().toLowerCase();

        // 1) 2km í•„í„°
        let base = allToilets;

        if (filter2kmOn && myPos) {
          const radius = 2000;
          base = allToilets.filter(t => {
            const lat = Number(t.lat), lng = Number(t.lng);
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
            return haversineMeters(myPos.lat, myPos.lng, lat, lng) <= radius;
          });
          $("rangeInfo").innerHTML = `í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ <span class="badge">2km</span> ì•ˆì— <span class="badge">${base.length}ê°œ</span>`;
        } else if (filter2kmOn && !myPos) {
          $("rangeInfo").innerHTML = `2km í•„í„° ON (í˜„ì¬ ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•´ìš”)`;
        } else {
          $("rangeInfo").innerHTML = `ì „ì²´ ë³´ê¸° <span class="badge">${allToilets.length}ê°œ</span>`;
        }

        // 2) ê²€ìƒ‰
        if (q) {
          base = base.filter(t => `${t.name} ${t.addr} ${t.gu}`.toLowerCase().includes(q));
        }

        viewToilets = base;

        // ëª©ë¡ + ì§€ë„ ë Œë”
        renderToiletList(viewToilets, selectedId);
        renderClusterMarkers(viewToilets);

        // í™”ë©´ ë§ì¶”ê¸°: 2kmë©´ ìœ„ì¹˜ ì¤‘ì‹¬, ì•„ë‹ˆë©´ ëª©ë¡ bounds
        if (myPos && filter2kmOn) {
          map.setView([myPos.lat, myPos.lng], 14);
        } else {
          fitTo(viewToilets);
        }
      }
function findById(id) {
  return allToilets.find(t => String(t.toiletId) === String(id)) || null;
}

      function renderToiletList(list, activeId) {
        const el = $("toiletList");
        if (!el) return;

        if (!list.length) {
          el.innerHTML = `
            <div class="item">
              <div class="title">ê²°ê³¼ê°€ ì—†ì–´ìš” ğŸ˜­</div>
              <div class="addr">ê²€ìƒ‰ì–´ë¥¼ ë°”ê¾¸ê±°ë‚˜ 2km í•„í„°ë¥¼ êº¼ë´!</div>
            </div>`;
          return;
        }

        el.innerHTML = list.slice(0, 400).map(t => { // ë„ˆë¬´ ë§ìœ¼ë©´ DOM ë¬´ê±°ì›Œì„œ 400ê°œë§Œ(ì§€ë„ì—” ë‹¤ ì°í˜)
          const isActive = t.toiletId === activeId;
          const gu = t.gu || "ì„œìš¸";
          const type = prettyPipe(t.openType) || "ê°œë°©ì •ë³´";
          const time = prettyPipe(t.openTime) || "ìš´ì˜ì •ë³´ ì—†ìŒ";
          const tel = (t.tel || "").trim();

          return `
            <div class="item ${isActive ? "active" : ""}" data-id="${escapeHtml(t.toiletId)}">
              <div class="itemTop">
                <span class="badge">${escapeHtml(gu)} Â· ${escapeHtml(type)}</span>
                <span class="badge">ID: ${escapeHtml(t.toiletId)}</span>
              </div>
              <div class="title">ğŸš» ${escapeHtml(t.name || "(ì´ë¦„ ì—†ìŒ)")}</div>
              <div class="addr">${escapeHtml(t.addr || "(ì£¼ì†Œ ì—†ìŒ)")}</div>
              <div class="metaLine">
                <span class="chip">â° ${escapeHtml(time)}</span>
                ${tel ? `<span class="chip">â˜ ${escapeHtml(tel)}</span>` : ""}
              </div>
            </div>`;
        }).join("");

        el.querySelectorAll(".item").forEach(node => {
          node.addEventListener("click", () => {
            selectToiletById(node.getAttribute("data-id"));
          });
        });
      }

      function renderDetail(selected, reviews) {
        if (!selected) {
          $("toiletTitle").textContent = "í™”ì¥ì‹¤ì„ ì„ íƒí•´ì¤˜";
          $("toiletMeta").textContent = "ì§€ë„ í•€ ë˜ëŠ” ì™¼ìª½ ëª©ë¡ì—ì„œ ì„ íƒí•´ì¤˜ ğŸ™‚";
          $("tags").innerHTML = "";
          $("scoreGrid").innerHTML = "";
          $("reviewList").innerHTML = `<div class="reviewItem"><p class="desc">ì„ íƒí•˜ë©´ ë¦¬ë·°ë¥¼ ë³¼ ìˆ˜ ìˆì–´!</p></div>`;
          return;
        }

        $("toiletTitle").textContent = `ğŸš» ${selected.name || "(ì´ë¦„ ì—†ìŒ)"}`;
        $("toiletMeta").textContent = selected.addr || "(ì£¼ì†Œ ì—†ìŒ)";

        const tags = [];
        if (selected.gu) tags.push(`ğŸ“ ${selected.gu}`);
        if (prettyPipe(selected.openType)) tags.push(`ğŸ”“ ${prettyPipe(selected.openType)}`);
        if (prettyPipe(selected.openTime)) tags.push(`â° ${prettyPipe(selected.openTime)}`);
        if (prettyPipe(selected.gender)) tags.push(`ğŸš» ${prettyPipe(selected.gender)}`);
        $("tags").innerHTML = tags.slice(0,4).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");

        const metrics = computeMetricsFromReviews(reviews);
        const items = [["ì²­ê²°", metrics["ì²­ê²°"]], ["ë¹„ë°", metrics["ë¹„ë°"]], ["íœ´ì§€", metrics["íœ´ì§€"]]];
        $("scoreGrid").innerHTML = items.map(([k,v]) => {
          const show = v == null ? "-" : v.toFixed(1);
          const color = v == null ? "var(--muted)" : moodColor(v);
          const hint = v == null ? "ë¦¬ë·° ì—†ìŒ" : "ë¦¬ë·° í‰ê· ";
          return `
            <div class="metric">
              <div class="k">${k}</div>
              <div class="v" style="color:${color}">${show}</div>
              <div class="hint">${hint}</div>
            </div>`;
        }).join("");

        if (!reviews.length) {
          $("reviewList").innerHTML = `<div class="reviewItem"><p class="desc">ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì¤˜ âœï¸</p></div>`;
        } else {
          $("reviewList").innerHTML = reviews.map(r => `
            <div class="reviewItem">
              <div class="itemTop">
                <span class="badge">${escapeHtml(r.category)}</span>
                <span class="stars">${starText(r.rating)}</span>
              </div>
              <p class="desc">${escapeHtml(r.text)}</p>
              <p class="sub">${escapeHtml(r.by)} Â· ${escapeHtml(r.time)}</p>
            </div>`).join("");
        }
      }

      function focusMap(toilet) {
        if (!toilet) return;
        const lat = Number(toilet.lat), lng = Number(toilet.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        map.setView([lat, lng], 17);
      }

      function selectToiletById(id) {
        const t = findById(id);
        if (!t) {
          selectedId = id || "";
          setToiletIdToURL(selectedId);
          selectedToilet = null;
          renderDetail(null, []);
          setDebug(`ì„ íƒí•œ IDê°€ í˜„ì¬ ë°ì´í„°ì— ì—†ì–´ìš” ğŸ˜­`, "warn");
          return;
        }

        selectedId = t.toiletId;
        selectedToilet = t;
        setToiletIdToURL(selectedId);

        const reviews = loadReviews(selectedId);
        renderDetail(selectedToilet, reviews);
        focusMap(selectedToilet);
        setDebug(`ì„ íƒë¨ âœ… ${escapeHtml(t.name)}`, "ok");
      }

      // ---------- geolocation ----------
      function setMyLocation(lat, lng) {
        myPos = { lat, lng };

        if (myMarker) map.removeLayer(myMarker);
        myMarker = L.circleMarker([lat, lng], {
          radius: 9,
          weight: 2,
          opacity: 1,
          fillOpacity: 0.35
        }).addTo(map);
        myMarker.bindPopup("ğŸ“ í˜„ì¬ ìœ„ì¹˜").openPopup();
      }

      // ---------- nearest + navigation ----------
function getNearestToilet(list, myPos) {
  if (!myPos) return null;

  let best = null;
  let bestD = Infinity;

  for (const t of list) {
    const lat = Number(t.lat), lng = Number(t.lng);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

    const d = haversineMeters(myPos.lat, myPos.lng, lat, lng);
    if (d < bestD) {
      bestD = d;
      best = { ...t, _distM: d };
    }
  }
  return best;
}

function openDirections(toilet) {
  if (!toilet) return;

  const lat = Number(toilet.lat);
  const lng = Number(toilet.lng);
  const name = toilet.name || "í™”ì¥ì‹¤";

  // âœ… ê°€ì¥ ì•ˆì •ì ì¸ ê¸¸ì•ˆë‚´: Google Maps (iOS/Android/PC ëª¨ë‘ OK)
  // í˜„ì¬ ìœ„ì¹˜â†’ëª©ì ì§€ ìë™ìœ¼ë¡œ ì¡í˜
  const gmap = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;

  // (ì„ íƒ) ì¹´ì¹´ì˜¤ë§µ/ë„¤ì´ë²„ë§µë„ ê°™ì´ ì›í•˜ë©´ ì•„ë˜ ë§í¬ë„ ë§Œë“¤ì–´ì¤„ê²Œ.
  window.open(gmap, "_blank");
}

function formatDistance(m) {
  if (!Number.isFinite(m)) return "";
  if (m < 1000) return `${Math.round(m)}m`;
  return `${(m/1000).toFixed(2)}km`;
}

// ë²„íŠ¼ ì´ë²¤íŠ¸
$("btnNearest").addEventListener("click", () => {
  if (!myPos) {
    setDebug("ë¨¼ì € ğŸ“ë‚´ ìœ„ì¹˜ ë²„íŠ¼ ëˆŒëŸ¬ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì¤˜!", "warn");
    requestMyLocation(); // ìˆìœ¼ë©´ í•œë²ˆ ë” ìš”ì²­
    return;
  }

  // 2km ONì´ë©´ í˜„ì¬ ë³´ì´ëŠ”(viewToilets)ì—ì„œ ì°¾ê³ ,
  // 2km OFFë©´ ì „ì²´(allToilets)ì—ì„œ ì°¾ê¸°
  const base = (filter2kmOn ? viewToilets : allToilets);

  const nearest = getNearestToilet(base, myPos);
  if (!nearest) {
    setDebug("ê°€ê¹Œìš´ í™”ì¥ì‹¤ì„ ì°¾ì§€ ëª»í–ˆì–´ ğŸ˜­ (ì¢Œí‘œ ì—†ëŠ” ë°ì´í„°ì¼ ìˆ˜ ìˆì–´)", "err");
    return;
  }

  // ì„ íƒ + ì§€ë„ ì´ë™ + ì•ˆë‚´
  selectToiletById(nearest.toiletId);
  setDebug(`ê°€ì¥ ê°€ê¹Œì›€ âœ… ${escapeHtml(nearest.name)} Â· ${formatDistance(nearest._distM)}`, "ok");
  openDirections(nearest);
});

      function requestMyLocation() {
        if (!navigator.geolocation) {
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            setMyLocation(lat, lng);
            applyFiltersAndRender();
          },
          () => alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì¤˜ì•¼ 2km í•„í„°ê°€ ë™ì‘í•´ìš”!"),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      }
function normalizeRow(r, idx) {
  const toiletId = r.toiletId || r.OBJECTID || r.POI_ID || r.ID || `ROW_${idx + 1}`;
  return {
    toiletId: String(toiletId),
    name: r.name || r.CONTS_NAME || r.FNAME || r.TOILET_NM || r.NAME || "(ì´ë¦„ ì—†ìŒ)",
    addr: r.addr || r.ADDR_NEW || r.ADR || r.ADDR || r.ADDRESS || "(ì£¼ì†Œ ì—†ìŒ)",
    lat: r.lat || r.COORD_Y || r.Y_WGS84 || r.LAT || "",
    lng: r.lng || r.COORD_X || r.X_WGS84 || r.LNG || "",
    gu: r.gu || r.GU_NAME || "",
    tel: r.tel || r.TEL_NO || "",
    openType: r.openType || r.VALUE_01 || "",
    openTime: r.openTime || r.VALUE_02 || "",
    gender: r.gender || r.VALUE_04 || ""
  };
}

      // ---------- load all ----------
      async function loadAllToilets() {
        setStatus(`ì„œìš¸ì‹œ ì „ì²´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦ <span class="badge">/api/toilets/all</span>`, "warn");
        try {
          const res = await fetch("/api/toilets/all");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          allToilets = (data.rows || []).map(normalizeRow);

          setStatus(
            `ì™„ë£Œ âœ… <span class="badge">${allToilets.length}ê°œ</span> ${data.cached ? "<span class='badge'>ìºì‹œ</span>" : ""}`,
            "ok"
          );

          // URL ë“¤ì–´ì˜¨ ê²½ìš° ë¨¼ì € ì„ íƒ ìœ ì§€
          const incoming = getToiletIdFromURL();
          if (incoming) {
            selectedId = incoming;
            $("pill").textContent = `toiletId: ${incoming}`;
          }

          applyFiltersAndRender();

          // URLë¡œ ë“¤ì–´ì˜¨ ì„ íƒì´ ìˆë‹¤ë©´ ìƒì„¸ í‘œì‹œê¹Œì§€
          if (incoming) selectToiletById(incoming);
          else renderDetail(null, []);
        } catch (e) {
          console.error(e);
          setStatus(`ì—ëŸ¬ âŒ ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ <span class="badge">${escapeHtml(String(e.message || e))}</span>`, "err");
        }
      }

      // ---------- bind events ----------
      $("q").addEventListener("input", () => applyFiltersAndRender());

      $("btnMyLocation").addEventListener("click", () => requestMyLocation());

      $("btnToggle2km").addEventListener("click", () => {
        filter2kmOn = !filter2kmOn;
        $("btnToggle2km").textContent = filter2kmOn ? "2km ON" : "2km OFF";
        applyFiltersAndRender();
      });
      <button class="primary" id="btnNearest">ğŸ§­ ê°€ì¥ ê°€ê¹Œìš´ í™”ì¥ì‹¤ ê¸¸ì•ˆë‚´</button>


      $("btnReload").addEventListener("click", () => loadAllToilets());

      $("btnAdd").addEventListener("click", () => {
        if (!selectedId || !selectedToilet) return setDebug("ë¨¼ì € í™”ì¥ì‹¤ì„ ì„ íƒí•´ì¤˜ ğŸ™‚", "warn");
        const category = $("category").value;
        const rating = $("rating").value;
        const text = $("comment").value.trim();
        if (text.length < 2) return setDebug("í›„ê¸°ë¥¼ 2ê¸€ì ì´ìƒ ì ì–´ì¤˜ ğŸ™‚", "warn");

        const updated = addReview(selectedId, { category, rating, text });
        $("comment").value = "";
        renderDetail(selectedToilet, updated);
        setDebug("ë¦¬ë·° ë“±ë¡ ì™„ë£Œ âœ…", "ok");
      });

      $("btnShare").addEventListener("click", async () => {
        const url = window.location.href;
        try {
          if (navigator.share) await navigator.share({ title: "HappyToilet", url });
          else await navigator.clipboard.writeText(url);
          setDebug("ê³µìœ /ë³µì‚¬ ì™„ë£Œ âœ…", "ok");
        } catch {
          setDebug("ê³µìœ ê°€ ì·¨ì†Œëì–´.", "warn");
        }
      });

      $("btnCopyQR").addEventListener("click", async () => {
        if (!selectedId) return setDebug("ë¨¼ì € í™”ì¥ì‹¤ì„ ì„ íƒí•´ì¤˜!", "warn");
        const url = new URL(window.location.href);
        url.searchParams.set("t", selectedId);
        try {
          await navigator.clipboard.writeText(url.toString());
          setDebug("QR/NFC ë§í¬ ë³µì‚¬ ì™„ë£Œ âœ…", "ok");
        } catch {
          setDebug("ë³µì‚¬ ì‹¤íŒ¨ ğŸ˜­", "err");
        }
      });

      // ---------- init ----------
      initMap();

      const incoming = getToiletIdFromURL();
      $("pill").textContent = `toiletId: ${incoming || "-"}`;

      // ì „ì²´ ë¨¼ì € ë¡œë“œ
      loadAllToilets();

      // 2km ê¸°ë³¸ ONì´ë‹ˆê¹Œ, ì´ˆê¸°ì—ë„ ìœ„ì¹˜ í•œë²ˆ ìš”ì²­(ì‚¬ìš©ì ê¶Œí•œ í•„ìš”)
      requestMyLocation();
    });
  </script>
</body>
</html>
